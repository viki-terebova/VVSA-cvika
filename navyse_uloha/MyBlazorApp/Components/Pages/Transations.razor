@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using MyBlazorApp.DatabaseModel

@inject IDbContextFactory<Whiyes5oContext> DbContextFactory

@page "/transactions"

<PageTitle>Transactions</PageTitle>

<h1>Transactions</h1>

<!-- Filter Section -->
<div class="card mb-3">
    <div class="card-body">
        <EditForm method="post" Model="FilterForm" FormName="filter" OnValidSubmit="ApplyFilters">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="filterMinAmount" class="form-label">Min Amount</label>
                    <InputText type="text"
                               id="filterMinAmount"
                               @bind-Value="FilterForm.MinAmount"
                               @oninput="OnMinAmountChanged"
                               class="form-control" />
                    <ValidationMessage For="() => FilterForm.MinAmount" class="text-danger" />
                </div>
            </div>
        </EditForm>
    </div>
</div>

<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Type</th>
            <th>Amount</th>
            <th>User</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var transaction in FilteredTransactionsList)
        {
            <tr>
                <td>@transaction.Id</td>
                <td>@transaction.TransactionType?.Name</td>
                <td>@transaction.Amount.ToString("C")</td>
                <td>@transaction.User?.Name</td>
                <td>
                    <a href="/transaction/@transaction.Id" class="btn btn-sm btn-primary">
                        View Detail 
                    </a>
                </td>
                <td>Delete</td>
            </tr>
        }
    </tbody>

</table>


@code {
    [SupplyParameterFromForm]
    public FilterFormDto FilterForm { get; set; } = null!;
    private List<Transaction> TransactionsList { get; set; } = new();
    private List<Transaction> FilteredTransactionsList { get; set; } = new();

    protected override void OnInitialized()
    {
        FilterForm ??= new FilterFormDto();
    }

    protected override async Task OnInitializedAsync()
    {
        using var dbContext = await DbContextFactory.CreateDbContextAsync();
        TransactionsList = await dbContext.Transactions
            .Include(t => t.TransactionType)
            .Include(t => t.User)
            .OrderByDescending(t => t.Id)
            .ToListAsync();
        FilteredTransactionsList = TransactionsList.ToList();
    }

    private Task OnMinAmountChanged(ChangeEventArgs e)
    {
        FilterForm.MinAmount = e.Value?.ToString();
        ApplyFilters();
        return Task.CompletedTask;
    }

    private void ApplyFilters()
    {
        if (!string.IsNullOrWhiteSpace(FilterForm.MinAmount) &&
            decimal.TryParse(FilterForm.MinAmount, out var minAmount))
        {
            FilteredTransactionsList = TransactionsList
                .Where(t => t.Amount >= minAmount)
                .ToList();
        }
        else
        {
            FilteredTransactionsList = TransactionsList.ToList();
        }
    }

    public class FilterFormDto
    {
        [Range(0, double.MaxValue, ErrorMessage = "Amount must be a positive number")]
        public string? MinAmount { get; set; }
    }
}
